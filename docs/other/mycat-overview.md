---
title: Mycat 概述
date: 2019-03-19 17:48:05
categories: Mycat
tags: [Mycat]
toc: true
---
通过本文学习 Mycat 的介绍、架构、原理、应用场景等。
<!-- more -->

## 1 Mycat 介绍

Mycat 是什么？从定义和分类来看，它是一个开源的分布式数据库系统，是一个实现了 MySQL 协议的的 Server ，前端用户可以把它看作是一个数据库代理，用 MySQL 客户端工具和命令行访问，而其后端可以用 MySQL 原生（ Native ）协议与多个 MySQL 服务器通信，也可以用 JDBC 协议与大多数主流数据库服务器通信。 Mycat 的前身是阿里巴巴的 Cobar ，**其核心功能是分表分库，即将一个大表水平分割为 N 个小表，存储在后端 MySQL 服务器里或者其他数据库里。可以这样理解：数据库是对底层存储文件的抽象，而 Mycat 是对数据库的抽象。**

Mycat 发展到目前的版本，已经不是一个单纯的 MySQL 代理了，它的后端可以支持 **MySQL、SQL Server、Oracle、DB2、PostgreSQL** 等主流数据库，也支持 **MongoDB** 这种新型 NoSQL 方式的存储，未来还会支持更多类型的存储。而在最终用户看来，无论是那种存储方式，在 Mycat 里，都是一个传统的数据库表，支持标准的 SQL 语句进行数据的操作，这样一来，对前端业务系统来说，可以大幅降低开发难度，提升开发速度。

在测试阶段，可以将一个表定义为任何一种 Mycat 支持的存储方式，比如 MySQL 的 MyASIM 表、内存表、或者 MongoDB、LevelDB 以及号称是世界上最快的内存数据库 MemSQL 上。试想一下，用户表存放在 MemSQL 上，大量读频率远超过写频率的数据如订单的快照数据存放于 InnoDB 中，一些日志数据存放于 MongoDB 中，而且还能把 Oracle 的表跟 MySQL 的表做关联查询，你是否有一种不能呼吸的感觉？而未来，还能通过 Mycat 自动将一些计算分析后的数据灌入到 Hadoop 中，并能用 Mycat+Storm/Spark Stream 引擎做大规模数据分析，看到这里，你大概明白了， Mycat 是什么？ Mycat 就是 BigSQL，Big Data On SQL Database。

对于 DBA 来说，可以这么理解 Mycat：Mycat 就是 MySQL Server ，而 Mycat 后面连接的 MySQL Server ，就好象是 MySQL 的存储引擎，如 InnoDB，MyISAM 等，因此，Mycat 本身并不存储数据，数据是在后端的 MySQL 上存储的，因此数据可靠性以及事务等都是 MySQL 保证的，简单的说， Mycat 就是 MySQL 最佳伴侣，它在一定程度上让 MySQL 拥有了能跟 Oracle PK 的能力。

对于软件工程师来说，可以这么理解 Mycat：Mycat 就是一个近似等于 MySQL 的数据库服务器，你可以用连接 MySQL 的方式去连接 Mycat （除了端口不同，默认的 Mycat 端口是 8066 而非 MySQL 的 3306 ，因此需要在连接字符串上增加端口信息），大多数情况下，可以用你熟悉的对象映射框架使用 Mycat ，但建议对于分片表，尽量使用基础的 SQL 语句，因为这样能达到最佳性能，特别是几千万甚至几百亿条记录的情况下。

对于架构师来说，可以这么理解 Mycat：Mycat 是一个强大的数据库中间件，不仅仅可以用作读写分离、以及分表分库、容灾备份，而且可以用于多租户应用开发、云平台基础设施、让你的架构具备很强的适应性和灵活性，借助于即将发布的 Mycat 智能优化模块，系统的数据访问瓶颈和热点一目了然，根据这些统计分析数据，你可以自动或手工调整后端存储，将不同的表映射到不同存储引擎上，而整个应用的代码一行也不用改变。

当前是个大数据的时代，但究竟怎样规模的数据适合数据库系统呢？对此，国外有一个数据库领域的权威人士说了一个结论：千亿以下的数据规模仍然是数据库领域的专长，而 Hadoop 等这种系统，更适合的是千亿以上的规模。所以， Mycat 适合 1000 亿条以下的单表规模，如果你的数据超过了这个规模，请投靠 Mycat Plus 吧！

## 2 Mycat 架构

![](https://oscimg.oschina.net/oscnet/966eebd4e2c05a6aaf284174579c6a80bc3.jpg)

## 3 Mycat 原理 

Mycat 的原理并不复杂，复杂的是代码，如果代码也不复杂，那么早就成为一个传说了。 Mycat 的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的SQL语句，首先对 SQL 语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此 SQL 发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。

![](https://static.oschina.net/uploads/space/2018/0119/165025_L8Hw_593078.png)

上述图片里， Orders 表被分为三个分片 datanode （简称 dn )，这三个分片是分布在两台 MySQL Server 上( DataHost )，即 datanode=database@datahost 方式，因此你可以用一台到N台服务器来分片，分片规则为（ sharding rule )典型的字符串枚举分片规则，一个规则的定义是分片字段（ sharding column )+分片函数( rule function )，这里的分片字段为 prov 而分片函数为字符串枚举方式。

当 Mycat 收到一个 SQL 时，会先解析这个 SQL ，查找涉及到的表，然后看此表的定义，如果有分片规则，则获取到 SQL 里分片字段的值，并匹配分片函数，得到该 SQL 对应的分片列表，然后将 SQL 发往这些分片去执行，最后收集和处理所有分片返回的结果数据，并输出到客户端。以 `select * from Orders where prov=?` 语句为例，查到 prov=wuhan ，按照分片函数， wuhan 返回 dn1 ，于是 SQL 就发给了 MySQL1 ，去取 DB1 上的查询结果，并返回给用户。

如果上述 SQL 改为 `select * from Orders where prov in (‘wuhan’,‘beijing’)` ，那么， SQL 就会发给 MySQL1 与 MySQL2 去执行，然后结果集合并后输出给用户。但通常业务中我们的 SQL 会有 Order By 以及 Limit 翻页语法，此时就涉及到结果集在 Mycat 端的二次处理，这部分的代码也比较复杂，而最复杂的则属两个表的 Jion 问题，为此， Mycat 提出了创新性的 ER 分片、全局表、HBT（Human Brain Tech) 人工智能的 Catlet 、以及结合 Storm/Spark 引擎等十八般武艺的解决办法，从而成为目前业界最强大的方案，这就是开源的力量！

## 4 Mycat 应用场景

Mycat 发展到现在，适用的场景已经很丰富，而且不断有新用户给出新的创新性的方案，以下是几个典型的应用场景：

- 单纯的**读写分离**，此时配置最为简单，支持读写分离，主从切换。
- **分表分库**，对于超过 1000 万的表进行分片，最大支持 1000 亿的单表分片。
- **多租户应用**，每个应用一个库，但应用程序只连接 Mycat ，从而不改造程序本身，实现多租户化。
- **报表系统**，借助于 Mycat 的分表能力，处理大规模报表的统计。
- 替代 Hbase ，**分析大数据**。
- 作为**海量数据实时查询**的一种简单有效方案，比如 100 亿条频繁查询的记录需要在 3 秒内查询出来结果，除了基于主键的查询，还可能存在范围查询或其他属性查询，此时 Mycat 可能是最简单有效的选择。

![](https://oscimg.oschina.net/oscnet/4aecc87084f7279620ed24724e95d8956f1.jpg)

![](https://oscimg.oschina.net/oscnet/1db940ad9ca3b165593d8f7b4b38707fa16.jpg)

## 5 Mycat 长期路线图

- 强化分布式数据库中间件的方面的功能，使之具备丰富的插件、强大的数据库智能优化功能、全面的系统监控能力、以及方便的数据运维工具，实现在线数据扩容、迁移等高级功能。
- 进一步挺进大数据计算领域，深度结合 Spark Stream 和 Storm 等分布式实时流引擎，能够完成快速的巨表关联、排序、分组聚合等 OLAP 方向的能力，并集成一些热门常用的实时分析算法，让工程师以及 DBA 们更容易用 Mycat 实现一些高级数据分析处理功能。
- 不断强化 Mycat 开源社区的技术水平，吸引更多的 IT 技术专家，使得 Mycat 社区成为中国的 Apache ，并将 Mycat 推到 Apache 基金会，成为国内顶尖开源项目，最终能够让一部分志愿者成为专职的 Mycat 开发者，荣耀跟实力一起提升。
- 依托 Mycat 社区，聚集 100 个 CXO 级别的精英，众筹建设亲亲山庄， Mycat 社区+亲亲山庄=中国最大 IT O2O 社区。


---

扫码关注微信公众号 **程序员35** ，获取最新技术干货，畅聊 #程序员的35，35的程序员# 。独立站点：[https://cxy35.com](https://cxy35.com)

![](https://oscimg.oschina.net/oscnet/up-285838b9c516db5bb1ba760f292f2346078.JPEG)